name: Claude Architecture Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "src/**/*.ts"
      - "src/**/*.tsx"
      - "src/**/*.graphql"
      - "src/**/*.js"
      - "src/**/*.jsx"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for auto-fix commits
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Architecture Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            PR #${{ github.event.pull_request.number }}: "${{ github.event.pull_request.title }}"
            Repo: ${{ github.repository }}
            Commit: ${{ github.event.pull_request.head.sha }}

            IMPORTANT: You MUST create inline comments on specific code lines in the "Files changed" view!

            Steps:
            1. cat architecture-rules.md | head -500
            2. gh pr diff ${{ github.event.pull_request.number }}
            3. Find ALL violations (Rules 1,2,3,4,7)
            4. For EACH violation, create inline comment:

            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
              -f body="‚ùå **Rule 1: Naming Convention**

            The enum name \`todo_priority\` should use PascalCase.

            **Fix**: Rename to \`TodoPriority\`

            **Why**: Rule 1 requires PascalCase for GraphQL types and enums (ISO 25010: Usability/Learnability)" \
              -f path="src/schema/todo.graphql" \
              -f line=28 \
              -f side="RIGHT" \
              -f commit_id="${{ github.event.pull_request.head.sha }}"

            5. After ALL inline comments: gh pr comment ${{ github.event.pull_request.number }} -b "# Review Summary
            ‚úÖ X inline comments posted
            Status: CHANGES_REQUESTED"

            Rules to check:
            - Rule 1: PascalCase types, camelCase fields, SCREAMING_SNAKE_CASE enums
            - Rule 2: Union types for mutations, structured errors
            - Rule 3: Winston logger (JSON), NO console.log
            - Rule 4: ISO 8601 DateTime, NO Unix timestamps
            - Rule 7: Explicit Zod validation

            CRITICAL: Create inline comment for EVERY single violation found!

          claude_args: |
            --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh pr list:*),Bash(gh api:*),Bash(cat:*),Bash(grep:*),Bash(find:*)"
            --model claude-sonnet-4-20250514

      - name: Check for Review Status
        if: always()
        run: |
          echo "Claude review completed"
          echo "Check PR comments for detailed feedback"

      - name: Auto-fix Architecture Violations
        id: claude-autofix
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            Auto-fix architecture violations in PR #${{ github.event.pull_request.number }}

            CRITICAL: You MUST use the Edit tool to fix the files! Just reading is not enough!

            Files to fix:
            1. src/schema/todo.graphql - Fix enum names and fields
            2. src/resolvers/todoResolver.ts - Remove console.log, add logger
            3. src/services/todoService.ts - Replace Date.now() with ISO 8601

            Required changes:
            ‚Ä¢ todo_priority ‚Üí TodoPriority (enum name)
            ‚Ä¢ low, medium, high, urgent ‚Üí LOW, MEDIUM, HIGH, URGENT (enum values)
            ‚Ä¢ priority_level ‚Üí priorityLevel (field)
            ‚Ä¢ priority_set_at ‚Üí prioritySetAt (field)
            ‚Ä¢ console.log(...) ‚Üí logger.info(...) (add import logger)
            ‚Ä¢ Date.now() ‚Üí new Date().toISOString()
            ‚Ä¢ Int timestamp ‚Üí DateTime scalar
            ‚Ä¢ Add Union type for setPriority mutation
            ‚Ä¢ Add Zod validation

            DO NOT commit - workflow will do that.

          claude_args: |
            --model claude-sonnet-4-20250514

      - name: Commit and Push Fixes
        if: success()
        run: |
          git config user.name "Claude Architecture Bot"
          git config user.email "claude-bot@anthropic.com"

          git add src/

          if git diff --staged --quiet; then
            echo "No fixes needed"
          else
            git commit -m "ü§ñ Auto-fix: Apply architecture compliance fixes

          Applied by Claude Architecture Review workflow

          Fixes:
          - Rule 1: Naming conventions (PascalCase, camelCase, SCREAMING_SNAKE_CASE)
          - Rule 2: Union types for error handling
          - Rule 3: Winston logger instead of console.log
          - Rule 4: ISO 8601 DateTime format
          - Rule 7: Zod validation

          Co-Authored-By: Claude <noreply@anthropic.com>"

            git push

            gh pr comment ${{ github.event.pull_request.number }} -b "‚úÖ **Auto-fix Applied**

            I've automatically fixed all architecture violations and pushed the changes to this PR.

            Please review the commit and verify the fixes are correct."
          fi