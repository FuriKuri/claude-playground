name: Claude Architecture Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "src/**/*.ts"
      - "src/**/*.tsx"
      - "src/**/*.graphql"
      - "src/**/*.js"
      - "src/**/*.jsx"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Volle History f√ºr besseren Kontext

      - name: Run Claude Architecture Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            # Architecture Review f√ºr PR #${{ github.event.pull_request.number }}
            
            **Repository**: ${{ github.repository }}
            **PR Title**: ${{ github.event.pull_request.title }}
            **PR Author**: @${{ github.event.pull_request.user.login }}
            **Base Branch**: ${{ github.event.pull_request.base.ref }}
            **Head Branch**: ${{ github.event.pull_request.head.ref }}
            
            ## Deine Aufgabe
            
            F√ºhre ein detailliertes Architecture Review durch:
            
            1. **Lies die Architektur-Regeln**:
               - Lies `architecture-rules.md` vollst√§ndig
               - Verstehe alle Regeln und ihre Schweregrade (MUSS/SOLLTE)
            
            2. **Analysiere den PR**:
               - Hole den PR Diff mit: `gh pr diff ${{ github.event.pull_request.number }}`
               - Hole alle ge√§nderten Dateien mit: `gh pr view ${{ github.event.pull_request.number }} --json files`
               - Untersuche besonders:
                 * GraphQL Schema-Dateien (.graphql)
                 * Resolver/Service Code (.ts)
                 * Event Publisher Code
                 * Logging Statements
                 * API Client Code
                 * Health Check Endpoints
            
            3. **Pr√ºfe gegen jede Regel**
            
            4. **Erstelle einen strukturierten Review-Report**:
            # üèóÔ∏è Architecture Review Report
            
            **PR**: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            **Reviewed by**: Claude (Sonnet 4.5)
            **Date**: $(date -I)
            
            ## üìä Summary
            
            - **Status**: [‚úÖ Approved / ‚ö†Ô∏è Approved with Comments / ‚ùå Changes Requested]
            - **Rules Checked**: 10
            - **MUSS Violations**: [Anzahl]
            - **SOLLTE Violations**: [Anzahl]
            - **Files Analyzed**: [Anzahl]
            
            ## üîç Detailed Findings
            
            [F√ºr jeden Versto√ü:]
            
            ### ‚ùå Violation: [Regel-ID] - [Regel-Name]
            
            **Severity**: [MUSS/SOLLTE]
            **File**: `[pfad/zur/datei.ts]`
            **Lines**: [X-Y]
            
            **Issue**:
            [Beschreibung des Problems]
            
            **Current Code**:
            [Aktueller Code-Snippet]
            
            **Recommendation**:
            [Verbesserter Code-Snippet]
            
            **Why**: [Verweis auf ISO-Qualit√§tsmerkmal und Begr√ºndung]
            
            ---
            
            ## ‚úÖ Positive Aspects
            
            [Was wurde gut gemacht?]
            
            ## üìù Recommendation
            
            [Gesamtbewertung und n√§chste Schritte]
            
            ## üìö References
            
            - Architecture Rules: `.claude/architecture-rules.md`
            - [Links zu relevanten Dokumentation]
            
            5. **Poste den Review**:
               - Verwende `gh pr comment ${{ github.event.pull_request.number }} --body-file review.md`
               - Bei MUSS-Verst√∂√üen: Kommentiere auch direkt an den betroffenen Code-Zeilen
            
            ## Wichtige Hinweise
            
            - Sei konstruktiv und hilfreich, nicht kritisch
            - Gib konkrete Code-Beispiele f√ºr Verbesserungen
            - Erkl√§re das "Warum" hinter jeder Regel
            - Betone auch positive Aspekte des PRs
            - Bei Unklarheiten: Stelle Fragen statt anzunehmen
            
            ## Tools die du verwenden kannst
            
            - `gh pr diff` - Zeigt √Ñnderungen
            - `gh pr view` - Zeigt PR Details
            - `gh pr comment` - Kommentiert den PR
            - `cat` - Liest Dateien
            - `grep` - Sucht in Dateien
            
            Beginne jetzt mit dem Review!

          claude_args: |
            --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh pr list:*),Bash(cat:*),Bash(grep:*),Bash(find:*)"
            --model claude-sonnet-4-20250514

      - name: Check for Review Status
        if: always()
        run: |
          echo "Claude review completed"
          echo "Check PR comments for detailed feedback"