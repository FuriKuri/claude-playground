name: Claude Architecture Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "src/**/*.ts"
      - "src/**/*.tsx"
      - "src/**/*.graphql"
      - "src/**/*.js"
      - "src/**/*.jsx"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for auto-fix commits
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Architecture Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            PR #${{ github.event.pull_request.number }}: "${{ github.event.pull_request.title }}"
            Repo: ${{ github.repository }}
            Commit: ${{ github.event.pull_request.head.sha }}

            IMPORTANT: You MUST create inline comments on specific code lines in the "Files changed" view!

            Steps:
            1. Read the complete architecture rules: cat architecture-rules.md
            2. Review the PR changes: gh pr diff ${{ github.event.pull_request.number }}
            3. Check compliance with ALL architecture rules defined in architecture-rules.md
            4. For EACH violation found, create an inline comment on the specific line:

            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
              -f body="‚ùå **Rule X: [Rule Name]**

            [Description of the violation]

            **Fix**: [How to fix it]

            **Why**: [Reference to rule in architecture-rules.md and ISO 25010 quality attribute]" \
              -f path="[file path]" \
              -f line=[line number] \
              -f side="RIGHT" \
              -f commit_id="${{ github.event.pull_request.head.sha }}"

            5. After ALL inline comments, post a summary: gh pr comment ${{ github.event.pull_request.number }} -b "# Architecture Review Summary

            [Summary of violations found, grouped by rule]

            Status: CHANGES_REQUESTED"

            CRITICAL:
            - Review against ALL rules from architecture-rules.md
            - Create inline comment for EVERY single violation found
            - Reference the specific rule number and name from architecture-rules.md
            - Include ISO 25010 quality attribute in violation explanation

          claude_args: |
            --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh pr list:*),Bash(gh api:*),Bash(cat:*),Bash(grep:*),Bash(find:*)"
            --model claude-sonnet-4-20250514

      - name: Check for Review Status
        if: always()
        run: |
          echo "Claude review completed"
          echo "Check PR comments for detailed feedback"

      - name: Auto-fix Architecture Violations
        run: |
          chmod +x .github/scripts/auto-fix-violations.js
          node .github/scripts/auto-fix-violations.js

      - name: Commit and Push Fixes
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Claude Architecture Bot"
          git config user.email "claude-bot@anthropic.com"

          # Configure git to use the GitHub token for authentication
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

          git add src/

          if git diff --staged --quiet; then
            echo "No fixes needed"
          else
            git commit -m "ü§ñ Auto-fix: Apply architecture compliance fixes

          Applied by Claude Architecture Review workflow

          Auto-fixed violations based on rules defined in architecture-rules.md

          Co-Authored-By: Claude <noreply@anthropic.com>"

            git push origin HEAD:${{ github.event.pull_request.head.ref }}

            gh pr comment ${{ github.event.pull_request.number }} -b "‚úÖ **Auto-fix Applied**

            I've automatically fixed all architecture violations and pushed the changes to this PR.

            Please review the commit and verify the fixes are correct."
          fi

      - name: Verify All Violations Fixed
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Verifying all violations have been fixed..."

          # Pull the latest changes after auto-fix
          git pull origin ${{ github.event.pull_request.head.ref }}

          # Run auto-fix script again in check-only mode
          node .github/scripts/auto-fix-violations.js

          # Check if there are any remaining changes needed
          git add src/
          if git diff --staged --quiet; then
            echo "‚úÖ SUCCESS: All violations have been fixed! Code is now compliant."

            gh pr comment ${{ github.event.pull_request.number }} -b "üéâ **Verification Complete**

            All architecture violations have been successfully fixed and verified.

            The code is now fully compliant with all architecture rules defined in architecture-rules.md.

            ‚úÖ Ready for review and merge!"
          else
            echo "‚ùå FAILURE: Some violations could not be automatically fixed!"
            echo "The following files still have issues:"
            git diff --staged --name-only

            gh pr comment ${{ github.event.pull_request.number }} -b "‚ö†Ô∏è **Manual Intervention Required**

            Some architecture violations could not be automatically fixed.

            Please review the remaining issues and fix them manually."

            exit 1
          fi