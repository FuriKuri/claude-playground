name: Claude Architecture Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "src/**/*.ts"
      - "src/**/*.tsx"
      - "src/**/*.graphql"
      - "src/**/*.js"
      - "src/**/*.jsx"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for auto-fix commits
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Architecture Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          
          prompt: |
            PR #${{ github.event.pull_request.number }}: "${{ github.event.pull_request.title }}"
            Repo: ${{ github.repository }}
            Commit: ${{ github.event.pull_request.head.sha }}

            IMPORTANT: You MUST create inline comments on specific code lines in the "Files changed" view!

            Steps:
            1. Read the complete architecture rules: cat architecture-rules.md
            2. Review the PR changes: gh pr diff ${{ github.event.pull_request.number }}
            3. Check compliance with ALL architecture rules defined in architecture-rules.md
            4. For EACH violation found, create an inline comment on the specific line:

            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
              -f body="‚ùå **Rule X: [Rule Name]**

            [Description of the violation]

            **Fix**: [How to fix it]

            **Why**: [Reference to rule in architecture-rules.md and ISO 25010 quality attribute]" \
              -f path="[file path]" \
              -f line=[line number] \
              -f side="RIGHT" \
              -f commit_id="${{ github.event.pull_request.head.sha }}"

            5. After ALL inline comments, post a summary: gh pr comment ${{ github.event.pull_request.number }} -b "# Architecture Review Summary

            [Summary of violations found, grouped by rule]

            Status: CHANGES_REQUESTED"

            CRITICAL:
            - Review against ALL rules from architecture-rules.md
            - Create inline comment for EVERY single violation found
            - Reference the specific rule number and name from architecture-rules.md
            - Include ISO 25010 quality attribute in violation explanation

          claude_args: |
            --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh pr list:*),Bash(gh api:*),Bash(cat:*),Bash(grep:*),Bash(find:*)"
            --model claude-sonnet-4-20250514

      - name: Check for Review Status
        if: always()
        run: |
          echo "Claude review completed"
          echo "Check PR comments for detailed feedback"

      - name: Auto-fix Architecture Violations
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            PR #${{ github.event.pull_request.number }}: "${{ github.event.pull_request.title }}"

            Your task: Apply ALL architecture fixes based on the inline review comments.

            Steps:
            1. Read architecture rules: cat architecture-rules.md
            2. Get all inline comments from the review: gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments
            3. For EACH inline comment that describes a violation:
               - Read the file mentioned in the comment
               - Apply the fix exactly as described in the comment
               - Use the Edit tool to make the change
            4. After fixing all violations, verify no issues remain

            IMPORTANT:
            - Fix ALL violations mentioned in inline comments
            - Follow the exact fix suggestions from the comments
            - Use architecture-rules.md as reference for proper patterns
            - Make precise, surgical edits - don't change unrelated code
            - If a comment suggests renaming snake_case to camelCase, do exactly that
            - If a comment suggests SCREAMING_SNAKE_CASE for enum values, apply it

            DO NOT create commits or push - just edit the files. The workflow will handle commits.

          claude_args: |
            --allowed-tools "Read,Edit,Bash(gh api:*),Bash(cat:*)"
            --model claude-sonnet-4-20250514

      - name: Commit and Push Fixes
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Claude Architecture Bot"
          git config user.email "claude-bot@anthropic.com"

          # Configure git to use the GitHub token for authentication
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

          git add src/

          if git diff --staged --quiet; then
            echo "No fixes needed"
          else
            git commit -m "ü§ñ Auto-fix: Apply architecture compliance fixes

          Applied by Claude Architecture Review workflow

          Auto-fixed violations based on rules defined in architecture-rules.md

          Co-Authored-By: Claude <noreply@anthropic.com>"

            git push origin HEAD:${{ github.event.pull_request.head.ref }}

            gh pr comment ${{ github.event.pull_request.number }} -b "‚úÖ **Auto-fix Applied**

            I've automatically fixed all architecture violations and pushed the changes to this PR.

            Please review the commit and verify the fixes are correct."
          fi

      - name: Verify All Violations Fixed
        uses: anthropics/claude-code-action@v1
        if: success()
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            PR #${{ github.event.pull_request.number }}: Verification after auto-fix

            Your task: Verify that ALL architecture violations have been fixed.

            Steps:
            1. Read architecture-rules.md
            2. Get the original inline comments: gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments
            3. For EACH violation that was mentioned in the comments:
               - Read the affected file
               - Verify the fix has been applied correctly
               - Check if the code now complies with the rule
            4. Summarize the verification results

            Then post a comment using gh pr comment:
            - If ALL violations are fixed: Post success comment (see below)
            - If ANY violations remain: Post failure comment and list remaining issues

            Success comment format:
            gh pr comment ${{ github.event.pull_request.number }} -b "üéâ **Verification Complete**

            All architecture violations have been successfully fixed and verified.

            The code is now fully compliant with all architecture rules defined in architecture-rules.md.

            ‚úÖ Ready for review and merge!"

            Failure comment format (if issues remain):
            gh pr comment ${{ github.event.pull_request.number }} -b "‚ö†Ô∏è **Manual Intervention Required**

            Some architecture violations could not be automatically fixed:

            [List the remaining violations]

            Please review and fix these manually."

          claude_args: |
            --allowed-tools "Read,Bash(gh api:*),Bash(gh pr comment:*),Bash(cat:*)"
            --model claude-sonnet-4-20250514